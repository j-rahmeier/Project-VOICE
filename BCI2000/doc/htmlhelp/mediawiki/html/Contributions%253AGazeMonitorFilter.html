<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>Contributions:GazeMonitorFilter - BCI2000 Help</title>
<link rel='shortcut icon' href='../../rsrc/favicon.ico' />
<style type='text/css'>
html { font-size:95%; font-family:arial,helvetica,sans-serif }
.printfooter { display:none }
#tocmain { font-size:81%; font-weight:bold; color:black; background-color:white; border:1px solid black; padding:1em; z-index:10; position:fixed; left:-1px; top:-1px; width:150px; }
#tocmain a { color:blue; text-decoration:none }
#tocmain ul { margin:0 0 0 0.4em; padding:0.1em 0 0 0.1em; list-style-position:outside; list-style-type:disc }
#tocmain li { text-indent:0; margin:0 0 0 1em; padding: 0 0 0 0 }
#tocmain p { margin:0; padding:0.1em 0 0 0.1em }
#tocmain .toc1 { margin-left:1.25em; }
#tocmain .toc2 { margin-left:2.25em; }
#tocmain .toc3 { margin-left:3.25em; }
#article { font-size:91%; position:absolute; left:200px; right:0; padding:1em; margin:0 }
</style>
</head>
<body>
 <div id='tocmain'>
 <a href='Main_Page.html'><img src='../../rsrc/bci2000logo.svg' alt='[Main Page]' /></a> <hr class="sep" /><p class="toc0"><a href="User_Tutorial%253ABCI2000_Tour.html">GettingStarted</a></p><ul></ul><p class="toc0"><a href="User_Reference%253AContents.html">User Manual</a></p><ul></ul><p class="toc0"><a href="Technical_Reference%253AContents.html">Technical Reference</a></p><ul></ul><p class="toc0"><a href="Programming_Reference%253AContents.html">Programming Manual</a></p><ul></ul><p class="toc0"><a href="Contributions%253AContents.html">Contributions</a></p><ul><li class="toc1"><a href="Contributions%253AADCs.html">Data Acquisition</a></li><li class="toc1"><a href="Contributions%253AFileWriters.html">File Formats</a></li><li class="toc1"><a href="Contributions%253ASignalProcessing.html">Signal Processing</a></li><li class="toc1"><a href="Contributions%253AApplications.html">Applications</a></li><li class="toc1"><a href="Contributions%253ATools.html">Tools</a></li></ul><hr class="sep" /><p class="toc0"><a href="BCI2000_Glossary.html">BCI2000 Glossary</a></p> </div>
 <div id='article'>
 <h1 class = "pagetitle">GazeMonitorFilter</h1>
 <p class = "subtitle">Contributions</p>
 <hr class = "sep" />
 <div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output"><div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="Contributions%253AGazeMonitorFilter.html#Synopsis"><span class="tocnumber">1</span> <span class="toctext">Synopsis</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="Contributions%253AGazeMonitorFilter.html#Location"><span class="tocnumber">2</span> <span class="toctext">Location</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="Contributions%253AGazeMonitorFilter.html#Versioning"><span class="tocnumber">3</span> <span class="toctext">Versioning</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="Contributions%253AGazeMonitorFilter.html#Authors"><span class="tocnumber">3.1</span> <span class="toctext">Authors</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="Contributions%253AGazeMonitorFilter.html#Version_History"><span class="tocnumber">3.2</span> <span class="toctext">Version History</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="Contributions%253AGazeMonitorFilter.html#Source_Code_Revisions"><span class="tocnumber">3.3</span> <span class="toctext">Source Code Revisions</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-7"><a href="Contributions%253AGazeMonitorFilter.html#Functional_Description"><span class="tocnumber">4</span> <span class="toctext">Functional Description</span></a>
<ul>
<li class="toclevel-2 tocsection-8"><a href="Contributions%253AGazeMonitorFilter.html#Fixation_Management"><span class="tocnumber">4.1</span> <span class="toctext">Fixation Management</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="Contributions%253AGazeMonitorFilter.html#Visualization"><span class="tocnumber">4.2</span> <span class="toctext">Visualization</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="Contributions%253AGazeMonitorFilter.html#Subject_Correction"><span class="tocnumber">4.3</span> <span class="toctext">Subject Correction</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-11"><a href="Contributions%253AGazeMonitorFilter.html#Integration_into_BCI2000"><span class="tocnumber">5</span> <span class="toctext">Integration into BCI2000</span></a></li>
<li class="toclevel-1 tocsection-12"><a href="Contributions%253AGazeMonitorFilter.html#Parameters"><span class="tocnumber">6</span> <span class="toctext">Parameters</span></a>
<ul>
<li class="toclevel-2 tocsection-13"><a href="Contributions%253AGazeMonitorFilter.html#Notes"><span class="tocnumber">6.1</span> <span class="toctext">Notes</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-14"><a href="Contributions%253AGazeMonitorFilter.html#State_Variables"><span class="tocnumber">7</span> <span class="toctext">State Variables</span></a></li>
<li class="toclevel-1 tocsection-15"><a href="Contributions%253AGazeMonitorFilter.html#Gaze_Correction_Mode"><span class="tocnumber">8</span> <span class="toctext">Gaze Correction Mode</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="Contributions%253AGazeMonitorFilter.html#Gaze_Correction_Procedure"><span class="tocnumber">8.1</span> <span class="toctext">Gaze Correction Procedure</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-17"><a href="Contributions%253AGazeMonitorFilter.html#Integration_of_GazeMonitorFilter_Capabilities"><span class="tocnumber">9</span> <span class="toctext">Integration of GazeMonitorFilter Capabilities</span></a>
<ul>
<li class="toclevel-2 tocsection-18"><a href="Contributions%253AGazeMonitorFilter.html#Triggering_Gaze_Correction_Mode_from_Within_a_Task"><span class="tocnumber">9.1</span> <span class="toctext">Triggering Gaze Correction Mode from Within a Task</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="Contributions%253AGazeMonitorFilter.html#Triggering_Gaze_Correction_Mode_Manually"><span class="tocnumber">9.2</span> <span class="toctext">Triggering Gaze Correction Mode Manually</span></a></li>
<li class="toclevel-2 tocsection-20"><a href="Contributions%253AGazeMonitorFilter.html#Reacting_to_Fixation_Violation_Within_a_Task"><span class="tocnumber">9.3</span> <span class="toctext">Reacting to Fixation Violation Within a Task</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-21"><a href="Contributions%253AGazeMonitorFilter.html#See_also"><span class="tocnumber">10</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Synopsis">Synopsis</span></h2>
<p>An application filter which greatly eases using the <a href="Contributions%253AEyetrackerLogger.html" title="Contributions:EyetrackerLogger">EyetrackerLogger</a> extension which is capable of visualizing eye tracker states in real time, manages fixation enforcement, and provides functionality for re-alignment of the subject.
</p>
<h2><span class="mw-headline" id="Location">Location</span></h2>
<p><a rel="nofollow" class="external free" href="http://www.bci2000.org/svn/trunk/src/contrib/Extensions/GazeMonitorFilter">http://www.bci2000.org/svn/trunk/src/contrib/Extensions/GazeMonitorFilter</a>
</p>
<h2><span class="mw-headline" id="Versioning">Versioning</span></h2>
<h3><span class="mw-headline" id="Authors">Authors</span></h3>
<p>Griffin Milsap (griffin.milsap@gmail.com)
</p><p>William Engelhardt (engelhardt@neurotechcenter.org)
</p>
<h3><span class="mw-headline" id="Version_History">Version History</span></h3>
<ul><li>07/08/2011: Initial release</li>
<li>07/02/2021: Addition of ChangeFixation and EyeLink eye tracker implementation</li>
<li>02/17/2023: Use EnableGazeMonitorFilter flag to enable filter.</li></ul>
<h3><span class="mw-headline" id="Source_Code_Revisions">Source Code Revisions</span></h3>
<ul><li>Initial development: 3389</li>
<li>Tested under: 3389</li>
<li>Known to compile under: 6327</li>
<li>Broken since: --</li></ul>
<h2><span class="mw-headline" id="Functional_Description">Functional Description</span></h2>
<p>GazeMonitorFilter is a "drop-in" application module extension which automatically performs tasks commonly associated with using an eye tracker.  It has been designed for use with the <a href="Contributions%253AEyetrackerLogger.html" title="Contributions:EyetrackerLogger">EyetrackerLogger</a> extension.  When added into an application module, the GazeMonitorFilter is capable of drawing to the application window or in a layer on top of the application visualization screen.  
</p>
<h3><span class="mw-headline" id="Fixation_Management">Fixation Management</span></h3>
<p>Even without eyetracker states, the GazeMonitorFilter is capable of drawing fixation images on the screen, but with Eyetracker&lt;Left/Right&gt;EyeGaze&lt;X/Y&gt; states, GazeMonitorFilter is capable of enforcing this fixation and setting the <code>FixationViolated</code> state which indicates violation of the fixation should it occur.  The fixation is entirely parameterized and allows for detailed configuration of fixation management.
</p>
<h3><span class="mw-headline" id="Visualization">Visualization</span></h3>
<p>GazeMonitorFilter is also capable of drawing a visualization of eye position (if it's logged) and gaze location (if it's logged) to the application window visualization screen.  This enables the experimenter to monitor the eye tracker states visually in realtime for early detection (and later correction) of acquiring poor gaze data.
</p>
<h3><span class="mw-headline" id="Subject_Correction">Subject Correction</span></h3>
<p>With many eye trackers, accuracy diminishes as gaze diverts from the center of the screen.  Even if the eye tracker is well calibrated, a sizable difference can exist between where the subject is actually looking and where the eye tracker gaze data reports the subject is looking.  With Tobii eye trackers, this was seen more prominently as the subject's head changed position or orientation.  GazeMonitorFilter provides functionality for giving the subject visual feedback and prompts which direct the subject to move back to the position they calibrated in.
</p><p>If asked nicely, the GazeMonitorFilter may also brew you a cup of coffee. 
</p>
<h2><span class="mw-headline" id="Integration_into_BCI2000">Integration into BCI2000</span></h2>
<p>Compile the extension into your application modules by enabling contributed extensions in your CMake configuration.  You can do this by going into your root build folder and deleting <code>CMakeCache.txt</code> and re-running the project batch file, or by running <code>cmake -i</code> and enabling <b>BUILD_GAZEMONITORFILTER</b>.
</p><p>In the batch file you run, append <code>--EnableGazeMonitorFilter=1</code> to the Application module you are using, such as <code>StimulusPresentation</code>. Without this, the GazeMonitorFilter parameters will not be generated.
</p>
<h2><span class="mw-headline" id="Parameters">Parameters</span></h2>
<p>The GazeMonitorFilter is configured in the Application tab within the GazeMonitor section.  The configurable parameters are:
</p>
<ul><li><code>VisualizeGazeMonitorFilter</code>  - Enables/Disables visualization of eye tracker states on the application visualization window</li>
<li><code>EnforceFixation</code> - Enables/Disables fixation management.</li>
<li><code>FixationX</code>  - Expression which defines requested fixation location X coordinate. (0.0 - 1.0)</li>
<li><code>FixationY</code> - Expression which defines requested fixation location Y coordinate. (0.0 - 1.0)</li>
<li><code>BlinkTime</code> - The amount of time allowed for which eye states reported by <a href="Contributions%253AEyetrackerLogger.html" title="Contributions:EyetrackerLogger">EyetrackerLogger</a> can remain "invalid" before fixation has been violated.</li>
<li><code>SaccadeTime</code> - The amount of time allowed for which valid gaze data reported by <a href="Contributions%253AEyetrackerLogger.html" title="Contributions:EyetrackerLogger">EyetrackerLogger</a> can exist outside of the designated fixation before fixation has been violated.</li>
<li><code>FixationRadius</code> - The maximum distance from the center of fixation (FixationX, FixationY) from which the gaze data can deviate without violating fixation.</li>
<li><code>FixationImage</code> - The image displayed at the center of fixation while fixation is not violated.</li>
<li><code>FixationViolationImage</code> - The image displayed at the center of fixation while fixation is violated.</li>
<li><code>FixationImageSize</code> - The fixation image size in percentage of the screen height</li>
<li><code>FixationViolationSound</code> - The sound played every time fixation has just been violated.</li>
<li><code>LogGazeInformation</code> - Log information about eye validity and fixation enforcement to the ApplicationLog.</li>
<li><code>ChangeFixation</code> - Allows for multiple fixations during one run.</li></ul>
<ul class="gallery mw-gallery-nolines center">
		<li class="gallerybox" style="width: 1005px"><div style="width: 1005px">
			<div class="thumb" style="width: 1000px;"><div style="margin:0px auto;"><a href="https://www.bci2000.org/mediawiki/index.php/File:ChangeFixation.PNG" class="image"><img alt="" src="../images/9/9d/ChangeFixation.PNG" decoding="async" width="455" height="300" /></a></div></div>
			<div class="gallerytext">
<p>Change Fixation parameter matrix. Any valid BCI2000 Expression can be used in the first column. If none of the expressions evaluate to true, then the Fixation center corresponds to the parameters FixationX and FixationY.
</p>
			</div>
		</div></li>
</ul>
<h3><span class="mw-headline" id="Notes">Notes</span></h3>
<ul><li>For <code>FixationX</code> and <code>FixationY</code>, the top left corner of the screen is (0.0, 0.0) and the bottom right corner of the screen is (1.0, 1.0)</li>
<li>Specifying large images for <code>FixationImage</code> and <code>FixationViolationImage</code> is not recommended as it may have a detrimental impact on overall system timing.</li>
<li>If either of the timing parameters (<code>BlinkTime</code> and <code>SaccadeTime</code>) trigger a fixation violation, fixation violation will not occur again when the other timing parameter triggers if fixation has not been acquired again. (Example: One second is allotted for <code>BlinkTime</code> and 4 seconds is allotted for <code>SaccadeTime</code>. Gaze moves outside of fixation and eyes close immediately thereafter and remain closed.  <code>FixationViolated</code> is set after one second of the eyes being closed, and is not thrown again when the four seconds of gaze existing outside the allowed fixation radius elapse.)</li>
<li>A Fixation image can be drawn when there is no gaze data available to enforce the fixation.  That said, FixationViolationImage, FixationViolationSound are not ever presented and the fixation timing and radius parameters remain unused due to lack of ability to determine if fixation has indeed been violated.</li>
<li>Real time visualization of gaze data on the application visualization screen is controlled by the <code>VisualizeGazeMonitorFilter</code> parameter declared by GazeMonitorFilter and the <code>AppWindow&lt;Spatial/Temporal&gt;Decimation</code> parameters declared by the ApplicationWindow class.  Control the performance of your system by decimating how often and how large GazeMonitorFilter visualization updates are.</li></ul>
<h2><span class="mw-headline" id="State_Variables">State Variables</span></h2>
<ul><li><code>FixationViolated</code> - This state is set to "1" when the GazeMonitorFilter has determined that fixation is violated and is set back to 0 when fixation is acquired again.</li>
<li><code>GazeCorrectionMode</code> - This state is monitored by GazeMonitorFilter.  When this state is set to "1", GazeMonitorFilter will perform the gaze correction procedure.  When the procedure has completed, the state is set by GazeMonitorFilter back to 0.</li>
<li><code>FixationDuration</code> - 16-bit state that records the duration of the gaze being continuously fixated. It restarts from 0 every time the fixation is violated. Its units are the same as SourceTime.</li></ul>
<h2><span class="mw-headline" id="Gaze_Correction_Mode">Gaze Correction Mode</span></h2>
<p>Gaze correction mode is initiated by setting the state <code>GazeCorrectionMode</code> to "1".  GazeMonitorFilter will then perform the gaze correction procedure and set the state back to "0" when the procedure has concluded.
</p><p>During the procedure, a prompt will be displayed to the subject on the application window at their current gaze location.  The prompt position is "smoothed" to increase readability of the prompt and is not an accurate representation of where the subject's gaze is located at any particular frame.  
</p>
<h3><span class="mw-headline" id="Gaze_Correction_Procedure">Gaze Correction Procedure</span></h3>
<ol><li>Subject is prompted to "Fixate".  The subject will need to move his/her gaze into the fixation position/radius in order to continue in the procedure.</li>
<li>Subject is prompted to move "Closer" to the screen or "Further" from the screen.  The subject will need to move his/her eyes to between 550mm and 600mm away from the screen in order to continue in the procedure. Once the subject is fixated and at the correct distance from the screen, the fixation radius indicator will turn green.</li>
<li>Subject must hold this position for four seconds.  After four seconds (and a visual count down prompt) the procedure will be complete and the <code>GazeCorrectionMode</code> will be set back to "0"</li></ol>
<ul><li>Note -- Eye position data is displayed to the experimenter through the application visualization window through the use of the <code>VisualizeGazeMonitorFilter</code> parameter if and only if eye position data is being logged.  If the subject calibrated with their eyes centered in the eye tracker's cameras, the experimenter can re-position the subject's head during this procedure based on the feedback provided by the application visualization window.  This eye position data was not included explicitly as part of the gaze correction procedure for ease of use.</li></ul>
<h2><span class="mw-headline" id="Integration_of_GazeMonitorFilter_Capabilities">Integration of GazeMonitorFilter Capabilities</span></h2>
<p>If you wish for your task to interact with the GazeMonitorFilter, you may need to make a few small source code modifications to your task.
</p>
<h3><span class="mw-headline" id="Triggering_Gaze_Correction_Mode_from_Within_a_Task">Triggering Gaze Correction Mode from Within a Task</span></h3>
<p>Integration of gaze correction mode into a task consists of setting the GazeCorrectionMode state to "1" if it exists, and waiting for the state to be set back to "0" before continuing with the run.  This is done as follows:
</p>
<ul><li>Check for the existence of the GazeCorrectionMode state in <code>Preflight()</code></li></ul>
<pre>void
MyTask::Preflight( const SignalProperties&amp;, SignalProperties&amp; ) const
{
  ...
  OptionalState( "GazeCorrectionMode" );
  ...
}
</pre>
<ul><li>To turn on gaze correction mode</li></ul>
<pre>if( States-&gt;Exists( "GazeCorrectionMode" ) )
{
  State( "GazeCorrectionMode" ) = 1;
  // Disable drawing of your stimuli in here
}
</pre>
<ul><li>To wait for gaze correction mode to complete</li></ul>
<pre>void
MyTask::Process( const GenericSignal&amp;, GenericSignal&amp; )
{
  ...
  if( !OptionalState( "GazeCorrectionMode", 0 ) )
  {
    // Update stimuli and continue performing task related things
  }
  ...
}
</pre>
<h3><span class="mw-headline" id="Triggering_Gaze_Correction_Mode_Manually">Triggering Gaze Correction Mode Manually</span></h3>
<p>The BCI2000 Operator provides "function" buttons which can be scripted to modify the environment.  The following changes are necessary to set one of the "function" buttons to modify the <code>GazeCorrectionMode</code> state in order to allow the experimenter to trigger this mode at will:
</p>
<ul><li>Open Operator.exe</li>
<li>File-&gt;Preferences</li>
<li>In the "Function Buttons" choose a button to modify and set the Name to "Correction" and the command to:</li></ul>
<pre>SET STATE GazeCorrectionMode 1
</pre>
<h3><span class="mw-headline" id="Reacting_to_Fixation_Violation_Within_a_Task">Reacting to Fixation Violation Within a Task</span></h3>
<p>It may be the case that you want your task to react to a fixation violation event; for example, you may end a trial if fixation has been violated.  To do this, make the following changes in your task's source code:
</p>
<ul><li>Check for the existence of the <code>FixationViolated</code> state in <code>Preflight()</code></li></ul>
<pre>void
MyTask::Preflight( const SignalProperties&amp;, SignalProperties&amp; ) const
{
  ...
  OptionalState( "FixationViolated" );
  ...
}
</pre>
<ul><li>Read the state this way wherever you need to react to it:</li></ul>
<pre>if( OptionalState( "FixationViolated", 0 ) )
{
  // React to the fixation being violated
}
</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<p><a href="Contributions%253AEyetrackerLogger.html" title="Contributions:EyetrackerLogger">Contributions:EyetrackerLogger</a>, <a href="Contributions%253AExtensions.html" title="Contributions:Extensions">Contributions:Extensions</a>
</p>
<!-- 
NewPP limit report
Cached time: 20230524052748
Cache expiry: 86400
Dynamic content: false
Complications: []
CPU time usage: 0.033 seconds
Real time usage: 0.036 seconds
Preprocessor visited node count: 105/1000000
Post‐expand include size: 15/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 1457/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    0.000      1 -total
-->

<!-- Saved in parser cache with key wikidb-bci_:pcache:idhash:2017-0!canonical and timestamp 20230524052748 and revision id 10092
 -->
</div></div><div class="printfooter">
Retrieved from "<a dir="ltr" href="http://www.bci2000.org/mediawiki/index.php?title=Contributions:GazeMonitorFilter&amp;oldid=10092">http://www.bci2000.org/mediawiki/index.php?title=Contributions:GazeMonitorFilter&amp;oldid=10092</a>"</div>
 </div>
</body>
</html>