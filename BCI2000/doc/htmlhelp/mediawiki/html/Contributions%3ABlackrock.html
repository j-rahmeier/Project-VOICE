<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>Contributions:Blackrock - BCI2000 Help</title>
<link rel='shortcut icon' href='../../rsrc/favicon.ico' />
<style type='text/css'>
html { font-size:95%; font-family:arial,helvetica,sans-serif }
.printfooter { display:none }
#tocmain { font-size:81%; font-weight:bold; color:black; background-color:white; border:1px solid black; padding:1em; z-index:10; position:fixed; left:-1px; top:-1px; width:150px; }
#tocmain a { color:blue; text-decoration:none }
#tocmain ul { margin:0 0 0 0.4em; padding:0.1em 0 0 0.1em; list-style-position:outside; list-style-type:disc }
#tocmain li { text-indent:0; margin:0 0 0 1em; padding: 0 0 0 0 }
#tocmain p { margin:0; padding:0.1em 0 0 0.1em }
#tocmain .toc1 { margin-left:1.25em; }
#tocmain .toc2 { margin-left:2.25em; }
#tocmain .toc3 { margin-left:3.25em; }
#article { font-size:91%; position:absolute; left:200px; right:0; padding:1em; margin:0 }
</style>
</head>
<body>
 <div id='tocmain'>
 <a href='Main_Page.html'><img src='../../rsrc/bci2000logo.svg' alt='[Main Page]' /></a> <hr class="sep" /><p class="toc0"><a href="User_Tutorial%253ABCI2000_Tour.html">GettingStarted</a></p><ul></ul><p class="toc0"><a href="User_Reference%253AContents.html">User Manual</a></p><ul></ul><p class="toc0"><a href="Technical_Reference%253AContents.html">Technical Reference</a></p><ul></ul><p class="toc0"><a href="Programming_Reference%253AContents.html">Programming Manual</a></p><ul></ul><p class="toc0"><a href="Contributions%253AContents.html">Contributions</a></p><ul><li class="toc1"><a href="Contributions%253AADCs.html">Data Acquisition</a></li><li class="toc1"><a href="Contributions%253AFileWriters.html">File Formats</a></li><li class="toc1"><a href="Contributions%253ASignalProcessing.html">Signal Processing</a></li><li class="toc1"><a href="Contributions%253AApplications.html">Applications</a></li><li class="toc1"><a href="Contributions%253ATools.html">Tools</a></li></ul><hr class="sep" /><p class="toc0"><a href="BCI2000_Glossary.html">BCI2000 Glossary</a></p> </div>
 <div id='article'>
 <h1 class = "pagetitle">Blackrock</h1>
 <p class = "subtitle">Contributions</p>
 <hr class = "sep" />
 <div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output"><div id="toc" class="toc" role="navigation" aria-labelledby="mw-toc-heading"><input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none" /><div class="toctitle" lang="en" dir="ltr"><h2 id="mw-toc-heading">Contents</h2><span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="Contributions%253ABlackrock.html#Synopsis"><span class="tocnumber">1</span> <span class="toctext">Synopsis</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="Contributions%253ABlackrock.html#Location"><span class="tocnumber">2</span> <span class="toctext">Location</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="Contributions%253ABlackrock.html#Versioning"><span class="tocnumber">3</span> <span class="toctext">Versioning</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="Contributions%253ABlackrock.html#Author"><span class="tocnumber">3.1</span> <span class="toctext">Author</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="Contributions%253ABlackrock.html#Version_History"><span class="tocnumber">3.2</span> <span class="toctext">Version History</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="Contributions%253ABlackrock.html#Source_Code_Revisions"><span class="tocnumber">3.3</span> <span class="toctext">Source Code Revisions</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-7"><a href="Contributions%253ABlackrock.html#Functional_Description"><span class="tocnumber">4</span> <span class="toctext">Functional Description</span></a>
<ul>
<li class="toclevel-2 tocsection-8"><a href="Contributions%253ABlackrock.html#System_Setup"><span class="tocnumber">4.1</span> <span class="toctext">System Setup</span></a>
<ul>
<li class="toclevel-3 tocsection-9"><a href="Contributions%253ABlackrock.html#Windows"><span class="tocnumber">4.1.1</span> <span class="toctext">Windows</span></a></li>
<li class="toclevel-3 tocsection-10"><a href="Contributions%253ABlackrock.html#Linux"><span class="tocnumber">4.1.2</span> <span class="toctext">Linux</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-11"><a href="Contributions%253ABlackrock.html#Blackrock_Firmware.2FCBSDK.2FCerelink_Notes"><span class="tocnumber">5</span> <span class="toctext">Blackrock Firmware/CBSDK/Cerelink Notes</span></a></li>
<li class="toclevel-1 tocsection-12"><a href="Contributions%253ABlackrock.html#Multi-NSP_Synchronization"><span class="tocnumber">6</span> <span class="toctext">Multi-NSP Synchronization</span></a></li>
<li class="toclevel-1 tocsection-13"><a href="Contributions%253ABlackrock.html#Parameters"><span class="tocnumber">7</span> <span class="toctext">Parameters</span></a>
<ul>
<li class="toclevel-2 tocsection-14"><a href="Contributions%253ABlackrock.html#SamplingRate"><span class="tocnumber">7.1</span> <span class="toctext">SamplingRate</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="Contributions%253ABlackrock.html#SampleBlockSize"><span class="tocnumber">7.2</span> <span class="toctext">SampleBlockSize</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="Contributions%253ABlackrock.html#ChannelNames"><span class="tocnumber">7.3</span> <span class="toctext">ChannelNames</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="Contributions%253ABlackrock.html#SourceChOffset.2FSourceChGain"><span class="tocnumber">7.4</span> <span class="toctext">SourceChOffset/SourceChGain</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="Contributions%253ABlackrock.html#NSPInstances"><span class="tocnumber">7.5</span> <span class="toctext">NSPInstances</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="Contributions%253ABlackrock.html#DigitalOutput"><span class="tocnumber">7.6</span> <span class="toctext">DigitalOutput</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-20"><a href="Contributions%253ABlackrock.html#States"><span class="tocnumber">8</span> <span class="toctext">States</span></a>
<ul>
<li class="toclevel-2 tocsection-21"><a href="Contributions%253ABlackrock.html#NSPSyncState"><span class="tocnumber">8.1</span> <span class="toctext">NSPSyncState</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-22"><a href="Contributions%253ABlackrock.html#See_also"><span class="tocnumber">9</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Synopsis">Synopsis</span></h2>
<p>The Blackrock acquisition module enables signal acquisition from Blackrock Microsystems Cerebus and Neuroport acquisition hardware through the "cbsdk" C++ API.
</p>
<h2><span class="mw-headline" id="Location">Location</span></h2>
<p><a rel="nofollow" class="external free" href="http://www.bci2000.org/svn/trunk/src/contrib/SignalSource/Blackrock">http://www.bci2000.org/svn/trunk/src/contrib/SignalSource/Blackrock</a>
</p>
<h2><span class="mw-headline" id="Versioning">Versioning</span></h2>
<h3><span class="mw-headline" id="Author">Author</span></h3>
<p>Griffin Milsap (griffin.milsap@gmail.com)
</p>
<h3><span class="mw-headline" id="Version_History">Version History</span></h3>
<ul><li>V3.2 -- Enabled Firmware 6.05+ to function through a silly hack</li>
<li>V3.1 -- Digital output implementation</li>
<li>V3.0 -- Multi-NSP support with hardware synchronization</li>
<li>V2.0 -- Auto-config based implementation, enhanced usability and stability</li>
<li>V1.0 -- Analog Signal Acquisition and Digital Filtering Functionality</li></ul>
<h3><span class="mw-headline" id="Source_Code_Revisions">Source Code Revisions</span></h3>
<ul><li>Initial development: 4365</li>
<li>Tested under: 5304</li>
<li>Known to compile under: 5304</li>
<li>Broken since: N/A</li></ul>
<h2><span class="mw-headline" id="Functional_Description">Functional Description</span></h2>
<p>The Blackrock source module is used for acquiring recordings from Blackrock NSP systems using CBSDK as provided through official Blackrock channels, or through CereLink (<a rel="nofollow" class="external free" href="https://github.com/dashesy/CereLink">https://github.com/dashesy/CereLink</a>).  It also happens to be one of the first BCI2000 SignalSource modules to function under Linux.  This documentation explains the parameterization and specifics on how to set up the system.
</p>
<h3><span class="mw-headline" id="System_Setup">System Setup</span></h3>
<p>Building the Blackrock module should copy .bat files for standard experiments into the batch directory.
</p><p>Ensure your machine is connected to a switch or router that the NSP is also connected to.  This module communicates to the NSP using UDP, and is susceptible to packet loss.  Ensure you have a commercial grade switch to avoid dropping packets.  You can also use a crossover cable to connect directly to the NSP, but this prevents other computers from receiving data from the NSP.
</p><p>You will also need to change your interface's network configuration (<a rel="nofollow" class="external text" href="http://www.howtogeek.com/howto/19249/how-to-assign-a-static-ip-address-in-xp-vista-or-windows-7/">Windows</a>):
</p>
<ul><li>IP address: 192.168.137.XXX where XXX is less than 128.  <u>This number needs to be below 16 and not 10.</u>  Ensure no other computers have this same address on this switch.</li>
<li>Subnet Mask: 255.255.255.0</li>
<li>Default Gateway: &lt;Blank&gt;</li></ul>
<p>To test your network configuration, open a terminal or command prompt and type <b>ping 192.168.137.128</b>. This is the NSP's default network address.  If you can ping the NSP, you should be able to run the module.
</p><p>For more details on the network setup for a multi-NSP system, please refer to the official NSP documentation
</p>
<h4><span class="mw-headline" id="Windows">Windows</span></h4>
<p>This should work out of the box with standard parameters.  
</p>
<h4><span class="mw-headline" id="Linux">Linux</span></h4>
<p>If you encounter a segfault or error message on SetConfig, one of the most common issues is with permissions.  NSP 6.03 and previous opens port 1002 and 1001 to communicate packets.  This was a rather unfortunate choice, as administrative privileges are required in order to open ports below 1024 on standard *nix systems.  NSP Firmware 6.04+ uses higher port numbers to avoid this problem.  If you're running 6.03 firmware or below, you will need to start the Blackrock module with administrative privileges.  One way to accomplish this is to comment out the "Start Blackrock" line in your batch file, and launch the Blackrock module from a separate terminal with "sudo ./Blackrock", executed from the bci2000/prog directory.  
</p><p>You may also receive an error complaining about the size of your network buffer size:
</p>
<pre>   Socket memory assignment error
   Consider using sysctl -w net.core.rmem_max=8388608
   or sysctl -w kern.ipc.maxsockbuf=8388608
</pre>
<p>Depending on your operating system (OSX or your favorite flavor of Linux) you should execute one of these commands with administrative privileges.  You will need to do this once every time the computer reboots.  There may be a way to do this on boot using some config file somewhere.  If you have any ideas, edit this section.  net.core.rmem_max is the proper key to use for Fedora 17.
</p>
<h2><span id="Blackrock_Firmware/CBSDK/Cerelink_Notes"></span><span class="mw-headline" id="Blackrock_Firmware.2FCBSDK.2FCerelink_Notes">Blackrock Firmware/CBSDK/Cerelink Notes</span></h2>
<p>When you install the Central "NeuroPort Windows Suite" software on a PC, it comes with a firmware, and a CBSDK distribution.  Unfortunately, these components have individual versioning.  The version of Central appears to match the NSP Firmware version.  Most of the development of this module has been done with Central/NSP Firmware 6.04.03.  CBSDK (hardware library) 3.9 is the compatible SDK for this particular firmware/version.  You can find out what version of central/firmware you're running by clicking the Windows-&gt;About Cerebus Suite button in Central when the NSP is on and active.
</p><p>The BCI2000 Blackrock module relies on cbsdk.dll to operate. The cbsdk.dll itself relies on a few Qt dlls (QtCore4.dll, QtXml4.dll) to function.  As a best-practice, you shouldn't copy these dlls into the BCI2000 prog directory, but instead add the directories that these files are found in to the system path.  <a rel="nofollow" class="external text" href="https://www.java.com/en/download/help/path.xml">Here is a helpful tutorial for how to change the system path in Windows (you'll need to restart BCI2000 after doing it)</a>.  You'll want to add:
</p>
<ul><li>C:\Program Files (x86)\Blackrock Microsystems\NeuroPort Windows Suite\cbsdk\lib (for cbsdk.dll)</li>
<li>C:\Program Files (x86)\Blackrock Microsystems\NeuroPort Windows Suite (for the Qt dlls)</li></ul>
<p>To further complicate things, a GPLV2 spinoff/fork of CBSDK is available in the <a rel="nofollow" class="external text" href="http://github.com/dashesy/CereLink">Cerelink repository</a> and is maintained by a non-Blackrock employee.  The source code there is available under GPLV2 (still copyrighted by Blackrock Microsystems), but it should be considered a fork of the official CBSDK code provided by Blackrock.  The code in CereLink currently contains a 3.9 compatible hardware library, and you *can* compile a cbsdk.dll from the code in this repository.  This dll will be similar, <i>but not identical</i> to the official 3.9 release.  If you want to rock a Linux Blackrock Source module, you'll need to compile this repository to generate a cbsdk.so for BCI2000 to use.  Blackrock doesn't provide an official Linux release.
</p><p>Unfortunately, Blackrock introduced a non-backward-compatible change to the ABI between CBSDK 3.9 and 3.10.  CBSDK 3.10 is *required* for firmware 6.05.XX+. Because this change isn't backward compatible, we had to make a choice as to what protocol version the module will currently support.  As of r5304, the Blackrock module is using CBSDK (hardware library) 3.9 and is only compatible with firmware version 6.04 and below.  <b>There is an experimental "hack" that enables this module to work with firmware 6.05+,</b> but use it at your own risk.  It seems to be quite stable, but it could result in undefined behavior.  Consider yourself warned.
</p><p>To make this module ONLY work with Firmware 6.05+:
</p>
<ul><li>Download BCI2000 SVN HEAD and use CMake to generate the build files, as detailed in <a href="Programming_Reference%253ABuild_System.html" class="mw-redirect" title="Programming Reference:Build System">Programming Reference:Build System</a>.  Make sure you enable Contributed source modules.</li>
<li>Edit src/contrib/SignalSource/Blackrock/lib/cbhwlib.h and make sure cbVERSION_MINOR is set to 10 (instead of 9)</li>
<li>Recompile the Blackrock module.</li></ul>
<p>The module will eventually default to using official hardware library 3.10 once the author updates his system to firmware 6.05.
</p>
<h2><span class="mw-headline" id="Multi-NSP_Synchronization">Multi-NSP Synchronization</span></h2>
<p>The NSP systems can be daisy-chained to provide access to more channels and more fun.  Although a hardware "sync" cable is provided by Blackrock Microsystems, the authors are a bit confused as to what it actually does, because it does not appear to synchronize the systems on a sample by sample basis.  CBSDK opens a separate instance for each NSP and the module is just communicating with both the systems simultaneously and attempting to match up the data streams as closely as possible.  To facilitate this, there is a hardware synchronization built into the module which requires a bit of hardware setup to use.  This system pulses one of the digital outputs high and provided that output is connected to the correct analog input on both NSPs, the streams will be resynchronized every time NSPSyncState is set to a value of 1.
</p><p>In order to enable NSP Hardware Synchronization:
</p>
<ul><li>Connect Digital Output 1 on any <b>one</b> of the NSPs to Analog Input 16 on all the NSPs.  You'll probably need BNC T-Connectors for this.</li>
<li>Ensure Analog Input 16 is in the same SampleGroup as the channels you wish to acquire using BCI2000.</li>
<li>If BCI2000 recognizes that Analog Input 16 is being acquired at the correct SamplingRate on all NSPs and that there is more than 1 NSP, hardware synchronization will occur automatically upon SetConfig.</li></ul>
<p>A hardware synchronization procedure strobes digital output 0 on the NSPs, consumes 100 ms worth of samples, then realigns the ringbuffers for each NSP to the rising edge of analog input 16.  A log message will tell you which instance was corrected by how many samples.  Throughout the course of a recording, dropped packets and clock skew will slowly throw the NSPs out of synchronization.  On the author's system, it takes about 10 minutes for a 100 ms desynchronization to occur.  At any time, NSPSyncState can be set to 1 (Especially handy as an operator function button -- see <a href="User_Reference%253AOperator_Module.html#Function_Buttons" title="User Reference:Operator Module">User_Reference:Operator_Module#Function_Buttons</a>), and the re-synchronization procedure will consume 100ms of data and resynchronize.  Its important to keep in mind that if the desynchronization is already greater than 100ms, the procedure will fail, due to there not being a rising edge in one of the signals.
</p>
<h2><span class="mw-headline" id="Parameters">Parameters</span></h2>
<p>This module used to fully-configure the NSPs directly from BCI2000.  The NSP system is sooo configurable that this became a big source of headaches.  In the most recent version, you will configure the recording setup using the Blackrock "Central" software, and BCI2000 will auto-configure to match the SampleGroup dictated by the SamplingRate parameter.  The NSPs always acquire data at 30Khz, but channels can be added to a SampleGroup which is downsampled (with antialiasing) in real-time by the NSP before being streamed over ethernet to receivers.  You can add channels to these channel groups in the Central software by enabling continuous streaming on individual channels, and selecting the sampling rate.
</p><p>The following parameters are available for configuring the Blackrock source module. You will find these parameters in the Source -- Signal Properties section. 
</p>
<h3><span class="mw-headline" id="SamplingRate">SamplingRate</span></h3>
<p>In standard use, this is one of two parameters you need to play with.  This is where you select the sample group you want BCI2000 to record from.  Valid sampling rates are 500 Hz, 1000 Hz, 2000 Hz, 10000 Hz, and 30000 Hz.  When the SetConfig button is pressed, BCI2000 will collect all channels that are members of that SampleGroup and configure to acquire from those channels.
</p>
<h3><span class="mw-headline" id="SampleBlockSize">SampleBlockSize</span></h3>
<p>There are a bunch of default SampleBlockSizes for the different SamplingRates, which you will get if you use 'auto' as the value of this parameter.  They are roughly set to clock BCI2000 at about 50 Hz. Depending on the processing you're doing, you may want to lengthen the block size. Any number of samples is valid here: even 1.  You may want to not do that, however.  Clocking the system above 50 Hz <a rel="nofollow" class="external text" href="http://www.youtube.com/watch?v=2FM3Em7FIOc">is a bad choice</a>.  The default block size for different sample groups is as follows:
</p>
<pre>   int gGroupRates[] = { 0, 500, 1000, 2000, 10000, 30000 }; // samples per second
   int gBlockSizes[] = { 0, 10,  20,   40,   200,   600   }; // samples per block (50 Hz)
</pre>
<h3><span class="mw-headline" id="ChannelNames">ChannelNames</span></h3>
<p>These will be pulled from the Channel Label property set in the Central Software.  Use 'auto' to configure this parameter.
</p>
<h3><span id="SourceChOffset/SourceChGain"></span><span class="mw-headline" id="SourceChOffset.2FSourceChGain">SourceChOffset/SourceChGain</span></h3>
<p>Again, these are populated automatically.  Use 'auto' to configure this parameter.
</p>
<h3><span class="mw-headline" id="NSPInstances">NSPInstances</span></h3>
<p>This parameter determines how many NSPs you intend to record from.  This is the other parameter that you might want to play with, but only if you have more than one NSP.  Setting this parameter to '2' enables the hardware synchronization described earlier, and using more than 2 NSPs is untested.
</p>
<h3><span class="mw-headline" id="DigitalOutput">DigitalOutput</span></h3>
<p>This parameter specifies a matrix of expressions that will be evaluated once per SampleBlock to set the digital output channels.  Each row of this matrix defines an expression for one digital output.  If that expression evaluates true for that block, the associated digital output will be set high, and vice versa for false.  See <a href="User_Reference%253AExpression_Syntax.html" title="User Reference:Expression Syntax">User Reference:Expression Syntax</a> for help with BCI2000 Expressions.  An example matrix is provided below.
</p>
<pre>   Instance Output Expression
   1        1      StimulusCode!=0 // Will set output 1 on NSP1 high whenever a stimulus is on screen
   2        3      KeyDown!=0 // Will set output 3 on NSP2 high whenever a key is pressed.
</pre>
<h2><span class="mw-headline" id="States">States</span></h2>
<h3><span class="mw-headline" id="NSPSyncState">NSPSyncState</span></h3>
<p>This state records the current status of the multi-NSP hardware synchronization described earlier.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<p><a href="User_Reference%253AFilters.html" title="User Reference:Filters">User Reference:Filters</a>, <a href="Contributions%253AADCs.html" title="Contributions:ADCs">Contributions:ADCs</a>
</p>
<!-- 
NewPP limit report
Cached time: 20230524182025
Cache expiry: 86400
Dynamic content: false
Complications: []
CPU time usage: 0.023 seconds
Real time usage: 0.027 seconds
Preprocessor visited node count: 71/1000000
Post‐expand include size: 15/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 0/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    0.000      1 -total
-->

<!-- Saved in parser cache with key wikidb-bci_:pcache:idhash:2056-0!canonical and timestamp 20230524182025 and revision id 7605
 -->
</div></div><div class="printfooter">
Retrieved from "<a dir="ltr" href="http://www.bci2000.org/mediawiki/index.php?title=Contributions:Blackrock&amp;oldid=7605">http://www.bci2000.org/mediawiki/index.php?title=Contributions:Blackrock&amp;oldid=7605</a>"</div>
 </div>
</body>
</html>